# ä¼˜åŒ»é—®è¯Š-é¡¹ç›®èµ·æ­¥

## é¡¹ç›®ä»‹ç»{#intro}
> çŸ¥é“ï¼šæ•´ä½“é¡¹ç›®æ¦‚å†µï¼Œå¹¶ä¸”çŸ¥é“è¯¾ç¨‹ä¸­ä¼šå®ç°å“ªäº›åŠŸèƒ½

- [äº§å“åŸå‹](https://app.mockplus.cn/s/dtKxarcngm8)
- [äº§å“è®¾è®¡](https://app.mockplus.cn/s/klLPNrzsU)
- [æ¥å£æ–‡æ¡£](https://apifox.com/apidoc/shared-aeb0d03e-c713-4f55-afaf-21cddf542751)
- [æ¼”ç¤ºé¡¹ç›®](https://cp.itheima.net/)

æ‰‹æœºç«¯æ¼”ç¤ºï¼š
<video width="400" controls src="http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/app/test/20220903/202209032213177645201.mp4"></video>

## èƒ½å­¦åˆ°ä»€ä¹ˆ{#what}
> äº†è§£ï¼šåœ¨é¡¹ç›®ä¸­ä¼šä½¿ç”¨åˆ°å“ªäº›æŠ€æœ¯æ–¹æ¡ˆå’Œç‰¹è‰²ä¸šåŠ¡

æŠ€æœ¯æ–¹æ¡ˆï¼š  
1. åŸºäº vue3+typescript ä¸­å¤§å‹é¡¹ç›®å¼€å‘è§£å†³æ–¹æ¡ˆ
2. åŸºäº vant ç»„ä»¶åº“å¿«é€Ÿæ„å»ºH5ç•Œé¢è§£å†³æ–¹æ¡ˆ
3. åŸºäº vue-router çš„å‰ç«¯è·¯ç”±è§£å†³æ–¹æ¡ˆ
4. åŸºäº vite çš„ create-vue æ„å»ºvue3é¡¹ç›®è§£å†³æ–¹æ¡ˆ
5. åŸºäº pinia çš„çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆ
6. åŸºäº pinia-plugin-persistedstate çŠ¶æ€æŒä¹…åŒ–è§£å†³æ–¹æ¡ˆ
7. åŸºäº @vuecore/use çš„ç»„åˆå¼APIå·¥å…·åº“è§£å†³æ–¹æ¡ˆ
7. èº«ä»½è¯ä¿¡æ¯æ ¡éªŒè§£å†³æ–¹æ¡ˆ
8. åŸºäº postcss-px-to-viewport ç§»åŠ¨ç«¯é€‚é…è§£å†³æ–¹æ¡ˆ
9.  åŸºäº vite-plugin-svg-icons çš„svgå›¾æ ‡ç»„ä»¶è§£å†³æ–¹æ¡ˆ
10. åŸºäº vite-plugin-html è‡ªå®šä¹‰htmlæ¨¡æ¿è§£å†³æ–¹æ¡ˆ
11. åŸºäº unplugin-vue-components ç»„ä»¶è‡ªåŠ¨æ³¨å†Œè§£å†³æ–¹æ¡ˆ
12. åŸºäº socket.io çš„å³æ—¶é€šè®¯é—®è¯Šå®¤è§£å†³æ–¹æ¡ˆ
13. ç¬¬ä¸‰æ–¹ç™»å½•è§£å†³æ–¹æ¡ˆ
14. ç¬¬ä¸‰æ–¹æ”¯ä»˜è§£å†³æ–¹æ¡ˆ
15. ç¬¬ä¸‰æ–¹åœ°å›¾è§£å†³æ–¹æ¡ˆ
16. pnpm åŒ…ç®¡ç†æ–¹æ¡ˆ
17. css å˜é‡ä¸»é¢˜å®šåˆ¶æ–¹æ¡ˆ
18. è‡ªå®šä¹‰ hook è§£å†³æ–¹æ¡ˆ
19. axios äºŒæ¬¡å°è£…è§£å†³æ–¹æ¡ˆ
20. services APIæ¥å£åˆ†å±‚è§£å†³æ–¹æ¡ˆ
21. åŸºäº vant çš„é€šç”¨ç»„ä»¶å°è£…è§£å†³æ–¹æ¡ˆ
22. mock æœ¬åœ°æ•°æ®æ¨¡æ‹Ÿè§£å†³æ–¹æ¡ˆ
23. åŸºäº eruda çš„ç§»åŠ¨ç«¯è°ƒè¯•è§£å†³æ–¹æ¡ˆ
24. ç”Ÿäº§ç¯å¢ƒé…ç½®æ–¹æ¡ˆ
25. CI/CD æŒç»­é›†æˆè‡ªåŠ¨éƒ¨ç½²æ–¹æ¡ˆ


ç‰¹è‰²ä¸šåŠ¡ï¼š  
1. åŒ»ç”Ÿä¸æ–‡ç« æ¨èä¸šåŠ¡
2. å¿«é€Ÿé—®è¯Šä¸šåŠ¡
3. é—®è¯Šè´¹ç”¨æ”¯ä»˜å®æ”¯ä»˜ä¸šåŠ¡
4. é—®è¯Šå®¤ä¸šåŠ¡
5. è¯å“è®¢å•æ”¯ä»˜å®æ”¯ä»˜ä¸šåŠ¡
6. å®æ—¶ç‰©æµé«˜å¾·åœ°å›¾ä¸šåŠ¡
7. QQç™»å½•ä¸šåŠ¡



## pnpmä»‹ç»&å®‰è£…{#pnpm}
> æŒæ¡ï¼špnpm çš„å®‰è£…å’Œä½¿ç”¨

æœ¬è´¨ä¸Šä»–æ˜¯ä¸€ä¸ªåŒ…ç®¡ç†å·¥å…·ï¼Œå’Œnpm/yarnæ²¡æœ‰åŒºåˆ«ï¼Œä¸»è¦ä¼˜åŠ¿åœ¨äº
- åŒ…å®‰è£…é€Ÿåº¦æå¿«
- ç£ç›˜ç©ºé—´åˆ©ç”¨æ•ˆç‡é«˜

å®‰è£…ï¼š
```sh
npm i pnpm -g
```

ä½¿ç”¨ï¼š

|npmå‘½ä»¤	| pnpmç­‰æ•ˆ|
| ---- | ---- |
|npm install	| pnpm install |
|npm i axios	| pnpm add axios |
|npm i webpack -D	| pnpm add webpack -D |
|npm run dev | pnpm dev |


å°ç»“ï¼š
- pnpm æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„åŒ…ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨å’Œnpmå’ŒyarnåŸºæœ¬ç›¸åŒ

## é¡¹ç›®åˆ›å»º{#create-vue}

> ä½¿ç”¨ create-vue è„šæ‰‹æ¶åˆ›å»ºé¡¹ç›®

create-vueå‚è€ƒåœ°å€ï¼šhttps://github.com/vuejs/create-vue

æ­¥éª¤ï¼š
1. æ‰§è¡Œåˆ›å»ºå‘½ä»¤
```bash
pnpm create vue
# or
npm init vue@latest
# or
yarn create vue
```

2. é€‰æ‹©é¡¹ç›®ä¾èµ–å†…å®¹

```bash
âœ” Project name: â€¦ patients-h5-100
âœ” Add TypeScript? â€¦ No / `Yes`
âœ” Add JSX Support? â€¦ `No` / Yes
âœ” Add Vue Router for Single Page Application development? â€¦ No / `Yes`
âœ” Add Pinia for state management? â€¦ No / `Yes`
âœ” Add Vitest for Unit Testing? â€¦ `No` / Yes
âœ” Add Cypress for both Unit and End-to-End testing? â€¦ `No` / Yes
âœ” Add ESLint for code quality? â€¦ No / `Yes`
âœ” Add Prettier for code formatting? â€¦ No / `Yes`

Scaffolding project in /Users/zhousg/Desktop/patient-h5-100...

Done. Now run:

  cd patient-h5-100
  pnpm install
  pnpm lint
  pnpm dev
```


## vscodeæ’ä»¶å®‰è£…{#ext}

> å®‰è£…ï¼šé¡¹ç›®å¼€å‘éœ€è¦çš„ä¸€äº›æ’ä»¶

å¿…è£…ï¼š
- `Vue Language Features (Volar)` vue3è¯­æ³•æ”¯æŒ 
- `TypeScript Vue Plugin (Volar)` vue3ä¸­æ›´å¥½çš„tsæç¤º
- `Eslint` ä»£ç é£æ ¼æ ¡éªŒ

:::warning æ³¨æ„
- vscode å®‰è£…äº† `Prettier` æ’ä»¶çš„å¯ä»¥å…ˆ `ç¦ç”¨`ï¼Œæˆ–è€…å…³é—­ä¿å­˜è‡ªåŠ¨æ ¼å¼åŒ–åŠŸèƒ½ï¼Œé¿å…å’Œé¡¹ç›®çš„ `Eslint` é£æ ¼å†²çªã€‚
:::


å¯é€‰ï¼š
- `gitLens` ä»£ç gitæäº¤è®°å½•æç¤º
- `json2ts` jsonè‡ªåŠ¨è½¬tsç±»å‹
- `Error Lens` è¡Œå†…é”™è¯¯æç¤º


æç¤ºï¼š
- å¤§ä¸­å‹é¡¹ç›®å»ºè®®å¼€å¯ [TSæ‰˜ç®¡æ¨¡å¼](https://staging-cn.vuejs.org/guide/typescript/overview.html#takeover-mode) , æ›´å¥½æ›´å¿«çš„ç±»å‹æç¤ºã€‚



## eslint é¢„åˆ¶é…ç½®{#eslint}

> ä½¿ç”¨ï¼šeslintçš„é¢„åˆ¶é…ç½®ï¼Œä¸”äº†è§£é…ç½®ä½œç”¨

```ts
  rules: {
    'prettier/prettier': [
      'warn',
      {
        singleQuote: true,
        semi: false,
        printWidth: 80,
        trailingComma: 'none',
        endOfLine: 'auto'
      }
    ],
    'vue/multi-word-component-names': [
      'warn',
      {
        ignores: ['index']
      }
    ],
    'vue/no-setup-props-destructure': ['off'],
    // ğŸ’¡ æ·»åŠ æœªå®šä¹‰å˜é‡é”™è¯¯æç¤ºï¼Œcreate-vue@3.6.3 å…³é—­ï¼Œè¿™é‡ŒåŠ ä¸Šæ˜¯ä¸ºäº†æ”¯æŒä¸‹ä¸€ä¸ªç« èŠ‚æ¼”ç¤ºã€‚
    'no-undef': 'error'
  }
```

- æ ¼å¼ï¼šå•å¼•å·ï¼Œæ²¡æœ‰åˆ†å·ï¼Œè¡Œå®½åº¦80å­—ç¬¦ï¼Œæ²¡æœ‰å¯¹è±¡æ•°ç»„æœ€åä¸€ä¸ªé€—å·ï¼Œæ¢è¡Œå­—ç¬¦ä¸²è‡ªåŠ¨ï¼ˆç³»ç»Ÿä¸ä¸€æ ·æ¢è¡Œç¬¦å·ä¸ä¸€æ ·ï¼‰
- vue ç»„ä»¶éœ€è¦å¤§é©¼å³°å‘½åï¼Œé™¤å» index ä¹‹å¤–ï¼ŒApp æ˜¯é»˜è®¤æ”¯æŒçš„
- å…è®¸å¯¹ props è¿›è¡Œè§£æ„ï¼Œæˆ‘ä»¬ä¼šå¼€å¯è§£æ„ä¿æŒå“åº”å¼çš„è¯­æ³•ç³–

æ‰§è¡Œï¼š
```bash
# ä¿®å¤æ ¼å¼
pnpm lint
```

vscode å¼€å¯ eslint  è‡ªåŠ¨ä¿®å¤
```json
    "editor.codeActionsOnSave": {
        "source.fixAll": true,
    },
```

å°ç»“ï¼š
- å¦‚æœå…¬å¸ä¸­ä¼šæœ‰è‡ªå·±çš„ä»£ç é£æ ¼è§„åˆ™ï¼Œå¤§å®¶åªéœ€éµå®ˆå³å¯
- https://prettier.io/docs/en/options.html å¸¸è§è§„åˆ™


## ä»£ç æ£€æŸ¥å·¥ä½œæµ

#### husky é…ç½®
- åˆå§‹åŒ–ä¸å®‰è£…
```bash
pnpm dlx husky-init && pnpm install
```
- ä¿®æ”¹ .husky/pre-commit æ–‡ä»¶
```bash
pnpm lint
```
#### lint-staged é…ç½®
- å®‰è£…
```bash
pnpm i lint-staged -D
```
- é…ç½® `package.json`
```json
{
  // ... çœç•¥ ...
  "lint-staged": {
    "*.{js,ts,vue}": [
      "eslint --fix"
    ]
  }
}
```
```json{4}
{
  "scripts": {
    // ... çœç•¥ ...
    "lint-staged": "lint-staged"
  }
}
```
- ä¿®æ”¹ .husky/pre-commit æ–‡ä»¶
```bash
pnpm lint-staged
```



## é¡¹ç›®ç»“æ„è°ƒæ•´{#dir}

> äº†è§£ï¼šæ¯ä¸€ä¸ªç›®å½•ç»“æ„çš„ä½œç”¨

```bash
./src
â”œâ”€â”€ assets        `é™æ€èµ„æºï¼Œå›¾ç‰‡...`
â”œâ”€â”€ components    `é€šç”¨ç»„ä»¶`
â”œâ”€â”€ composable    `ç»„åˆåŠŸèƒ½é€šç”¨å‡½æ•°`
â”œâ”€â”€ icons         `svgå›¾æ ‡`
â”œâ”€â”€ router        `è·¯ç”±`
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ services      `æ¥å£æœåŠ¡API`
â”œâ”€â”€ stores        `çŠ¶æ€ä»“åº“`
â”œâ”€â”€ styles        `æ ·å¼`
â”‚   â””â”€â”€ main.scss
â”œâ”€â”€ types         `TSç±»å‹`
â”œâ”€â”€ utils         `å·¥å…·å‡½æ•°`
â”œâ”€â”€ views         `é¡µé¢`
â”œâ”€â”€ main.ts       `å…¥å£æ–‡ä»¶`
â””â”€â”€App.vue       `æ ¹ç»„ä»¶`
```


é¡¹ç›®ä½¿ç”¨sassé¢„å¤„ç†å™¨ï¼Œå®‰è£…sassï¼Œå³å¯æ”¯æŒscssè¯­æ³•ï¼š
```bash
pnpm add sass -D
```


## è·¯ç”±ä»£ç è§£æ{#router}

> çŸ¥é“ï¼šé»˜è®¤ç”Ÿæˆçš„è·¯ç”±ä»£ç çš„å«ä¹‰


```ts
import { createRouter, createWebHistory } from 'vue-router'

// createRouter åˆ›å»ºè·¯ç”±å®ä¾‹ï¼Œ===> new VueRouter()
// history æ˜¯è·¯ç”±æ¨¡å¼ï¼Œhashæ¨¡å¼ï¼Œhistoryæ¨¡å¼
// createWebHistory() æ˜¯å¼€å¯historyæ¨¡å—   http://xxx/user
// createWebHashHistory() æ˜¯å¼€å¯hashæ¨¡å¼    http://xxx/#/user

// vite çš„é…ç½® import.meta.env.BASE_URL æ˜¯è·¯ç”±çš„åŸºå‡†åœ°å€ï¼Œé»˜è®¤æ˜¯ â€™/â€˜
// https://vitejs.dev/guide/build.html#public-base-path
// å¦‚æœå°†æ¥ä½ éƒ¨ç½²çš„åŸŸåè·¯å¾„æ˜¯ï¼šhttp://xxx/my-path/user
// vite.config.ts  æ·»åŠ é…ç½®  base: my-pathï¼Œè·¯ç”±è¿™å°±ä¼šåŠ ä¸Š my-path å‰ç¼€äº†

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: []
})

export default router

```

å°ç»“ï¼š
- å¦‚ä½•åˆ›å»ºå®ä¾‹çš„æ–¹å¼ï¼Ÿ
  - `createRouter()`

- å¦‚ä½•è®¾ç½®è·¯ç”±æ¨¡å¼ï¼Ÿ
  - `createWebHistory()`  æˆ–è€…  `createWebHashHistory()`

- `import.meta.env.BASE_URL` å€¼æ¥è‡ªå“ªé‡Œï¼Ÿ
  - `vite.config.ts` çš„ `base` å±æ€§çš„å€¼

- `base` ä½œç”¨æ˜¯ä»€ä¹ˆ?
  - é¡¹ç›®çš„åŸºç¡€è·¯å¾„å‰ç¼€ï¼Œé»˜è®¤æ˜¯ `/`

## vantç»„ä»¶åº“{#vant}

> å®ç°ï¼šå®Œæ•´ä½¿ç”¨vantç»„ä»¶åº“

[æ–‡æ¡£](https://vant-contrib.gitee.io/vant/#/zh-CN/quickstart#dao-ru-suo-you-zu-jian-bu-tui-jian)

å®‰è£…ï¼š
```bash
# Vue 3 é¡¹ç›®ï¼Œå®‰è£…æœ€æ–°ç‰ˆ Vant
npm i vant
# é€šè¿‡ yarn å®‰è£…
yarn add vant
# é€šè¿‡ pnpm å®‰è£…
pnpm add vant
```

æ ·å¼ï¼š`main.ts`
```ts{5,6}
import { createApp } from 'vue'
import App from './App.vue'
import pinia from './stores'
import router from './router'
// æ ·å¼å…¨å±€ä½¿ç”¨
import 'vant/lib/index.css'
import './styles/main.scss'

const app = createApp(App)

app.use(pinia)
app.use(router)
app.mount('#app')
```


ç»„ä»¶æŒ‰éœ€ä½¿ç”¨ï¼š`App.vue`
```vue
<script setup lang="ts">
import { Button as VanButton } from 'vant'
</script>

<template>
  <van-button>æŒ‰é’®</van-button>
</template>

<style scoped></style>
```

æé—®ï¼šä¸ºä»€ä¹ˆä¸å…¨å±€ä½¿ç”¨ï¼Ÿ
- å…¨å±€ä½¿ç”¨æ˜¯å…¨é‡åŠ è½½ï¼Œæ˜¯é¡¹ç›®ä½“ç§¯å˜å¤§ï¼ŒåŠ è½½æ…¢

## ç§»åŠ¨ç«¯é€‚é…{#vw}

> å®ç°ï¼šä½¿ç”¨ vw å®Œæˆç§»åŠ¨ç«¯é€‚é…

[æ–‡æ¡£](https://vant-contrib.gitee.io/vant/#/zh-CN/advanced-usage#viewport-bu-ju)

å®‰è£…ï¼š
```bash
npm install postcss-px-to-viewport -D
# or
yarn add -D postcss-px-to-viewport
# or
pnpm add -D postcss-px-to-viewport
```

é…ç½®ï¼š
`postcss.config.js`

```js
// eslint-disable-next-line no-undef
module.exports = {
  plugins: {
    'postcss-px-to-viewport': {
      // è®¾å¤‡å®½åº¦375è®¡ç®—vwçš„å€¼
      viewportWidth: 375,
    },
  },
};
```

æµ‹è¯•ï¼š

![image-20220731214535978](./images/image-20220731214535978.png)

- æœ‰ä¸€ä¸ªæ§åˆ¶å°è­¦å‘Šå¯å¿½ç•¥ï¼Œæˆ–è€…ä½¿ç”¨ `postcss-px-to-viewport-8-plugin` ä»£æ›¿å½“å‰æ’ä»¶

## csså˜é‡ä¸»é¢˜å®šåˆ¶{#css-var}

> å®ç°ï¼šä½¿ç”¨csså˜é‡å®šåˆ¶é¡¹ç›®ä¸»é¢˜ï¼Œå’Œä¿®æ”¹vantä¸»é¢˜


- å¦‚æœå®šä¹‰ css å˜é‡ä½¿ç”¨ css å˜é‡
```css
:root {
  --main: #999;
}
a {
  color: var(--main)
}
```

- å®šä¹‰é¡¹ç›®çš„é¢œè‰²é£æ ¼ï¼Œè¦†ç›–vantçš„ä¸»é¢˜è‰²  [å®˜æ–¹æ–‡æ¡£](https://vant-contrib.gitee.io/vant/#/zh-CN/config-provider#ji-chu-bian-liang)

`styles/main.scss`
```scss
:root {
  // é—®è¯Šæ‚£è€…ï¼šè‰²æ¿
  --cp-primary: #16C2A3;
  --cp-plain: #EAF8F6;
  --cp-orange: #FCA21C;
  --cp-text1: #121826;
  --cp-text2: #3C3E42;
  --cp-text3: #6F6F6F;
  --cp-tag: #848484;
  --cp-dark: #979797;
  --cp-tip: #C3C3C5;
  --cp-disable: #D9DBDE;
  --cp-line: #EDEDED;
  --cp-bg: #F6F7F9;
  --cp-price: #EB5757;
  // è¦†ç›–vantä¸»ä½“è‰²
  --van-primary-color: var(--cp-primary);
}
```

`App.vue`
```vue
<script setup lang="ts"></script>

<template>
  <!-- éªŒè¯vanté¢œè‰²è¢«è¦†ç›– -->
  <van-button type="primary">æŒ‰é’®</van-button>
  <a href="#">123</a>
</template>

<style scoped lang="scss">
// ä½¿ç”¨ css å˜é‡
a {
  color: var(--cp-primary);
}
</style>
```


## ç”¨æˆ·çŠ¶æ€ä»“åº“{#store}

> å®Œæˆï¼šç”¨æˆ·ä¿¡æ¯ä»“åº“åˆ›å»ºï¼Œæä¾›ç”¨æˆ·ä¿¡æ¯ï¼Œä¿®æ”¹ç”¨ä¿¡æ¯ï¼Œåˆ é™¤ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ³•

- è¯·æ±‚å·¥å…·éœ€è¦æºå¸¦tokenï¼Œè®¿é—®æƒé™æ§åˆ¶éœ€è¦tokenï¼Œæ‰€ä»¥ç”¨æˆ·ä¿¡æ¯ä»“åº“å…ˆå®Œæˆ

éœ€æ±‚ï¼š
- ç”¨æˆ·ä¿¡æ¯ä»“åº“åˆ›å»º
- æä¾›ç”¨æˆ·ä¿¡æ¯
- ä¿®æ”¹ç”¨ä¿¡æ¯çš„æ–¹æ³•
- åˆ é™¤ç”¨ä¿¡æ¯çš„æ–¹æ³•

ä»£ç ï¼š

`types/user.d.ts`
```ts
// ç”¨æˆ·ä¿¡æ¯
export type User = {
  /** tokenä»¤ç‰Œ */
  token: string
  /** ç”¨æˆ·ID */
  id: string
  /** ç”¨æˆ·åç§° */
  account: string
  /** æ‰‹æœºå· */
  mobile: string
  /** å¤´åƒ */
  avatar: string
}
```

`stores/user.ts`
```ts
import type { User } from '@/types/user'
import { defineStore } from 'pinia'
import { ref } from 'vue'

export const useUserStore = defineStore('cp-user', () => {
  // ç”¨æˆ·ä¿¡æ¯
  const user = ref<User>()
  // è®¾ç½®ç”¨æˆ·ï¼Œç™»å½•åä½¿ç”¨
  const setUser = (u: User) => {
    user.value = u
  }
  // æ¸…ç©ºç”¨æˆ·ï¼Œé€€å‡ºåä½¿ç”¨
  const delUser = () => {
    user.value = undefined
  }
  return { user, setUser, delUser }
})
```

å°ç»“ï¼š
- piniaå­˜å‚¨è¿™ä¸ªæ•°æ®çš„æ„ä¹‰ï¼Ÿ
  - æ•°æ®å…±äº«ï¼Œæä¾›ç»™é¡¹ç›®ä¸­ä»»ä½•ä½ç½®ä½¿ç”¨

- å¦‚æœå­˜å‚¨äº†æ•°æ®ï¼Œåˆ·æ–°é¡µé¢åæ•°æ®è¿˜åœ¨å—ï¼Ÿ
  - ä¸åœ¨ï¼Œç°åœ¨ä»…ä»…æ˜¯jså†…å­˜ä¸­ï¼Œéœ€è¦è¿›è¡Œæœ¬åœ°å­˜å‚¨ï¼ˆæŒä¹…åŒ–ï¼‰

## æ•°æ®æŒä¹…åŒ–{#persisted}

> æŒæ¡ï¼šä½¿ç”¨ `pinia-plugin-persistedstate` å®ç°piniaä»“åº“çŠ¶æ€æŒä¹…åŒ–ï¼Œä¸”å®Œæˆæµ‹è¯•

[å‚è€ƒæ–‡æ¡£](https://www.npmjs.com/package/pinia-plugin-persistedstate)

![image-20220730222310940](./images/image-20220730222310940.png)

- å®‰è£…
```bash
pnpm i pinia-plugin-persistedstate
# or
npm i pinia-plugin-persistedstate
# or
yarn add pinia-plugin-persistedstate
```
- ä½¿ç”¨ `main.ts`
```ts{1,4}
import persist from 'pinia-plugin-persistedstate'
const app = createApp(App)

app.use(createPinia().use(persist))
```

- é…ç½® `stores/user.ts`
```ts{20-22}
import type { User } from '@/types/user'
import { defineStore } from 'pinia'
import { ref } from 'vue'

export const useUserStore = defineStore(
  'cp-user',
  () => {
    // ç”¨æˆ·ä¿¡æ¯
    const user = ref<User>()
    // è®¾ç½®ç”¨æˆ·ï¼Œç™»å½•åä½¿ç”¨
    const setUser = (u: User) => {
      user.value = u
    }
    // æ¸…ç©ºç”¨æˆ·ï¼Œé€€å‡ºåä½¿ç”¨
    const delUser = () => {
      user.value = undefined
    }
    return { user, setUser, delUser }
  },
  {
    persist: true
  }
)

```

- æµ‹è¯• `App.vue`

```vue
<script setup lang="ts">
import { useUserStore } from './stores/user'

const store = useUserStore()
</script>

<template>
  <p>{{ store.user }}</p>
  <button @click="store.setUser({ id: '1', mobile: '1', account: '1', avatar: '1', token: '1' })">
    ç™»å½•
  </button>
  <button @click="store.delUser()">é€€å‡º</button>
</template>
```



## storesç»Ÿä¸€å¯¼å‡º{#stores-export}
> å®ç°ï¼šä»“åº“çš„å¯¼å‡ºç»Ÿä¸€ä» `./stores`  ä»£ç ç®€æ´ï¼ŒèŒèƒ½å•ä¸€ï¼Œå…¥å£å”¯ä¸€

- æŠ½å–piniaå®ä¾‹ä»£ç ï¼ŒèŒèƒ½å•ä¸€

`stores/index`
```ts
import { createPinia } from 'pinia'
import persist from 'pinia-plugin-persistedstate'

// åˆ›å»ºpiniaå®ä¾‹
const pinia = createPinia()
// ä½¿ç”¨piniaæ’ä»¶
pinia.use(persist)
// å¯¼å‡ºpiniaå®ä¾‹ï¼Œç»™mainä½¿ç”¨
export default pinia
```
`main.ts`
```ts{3,9}
import { createApp } from 'vue'
import App from './App.vue'
import pinia from './stores'
import router from './router'
import './styles/main.scss'

const app = createApp(App)

app.use(pinia)
app.use(router)
app.mount('#app')
```

- ç»Ÿä¸€å¯¼å‡ºï¼Œä»£ç ç®€æ´ï¼Œå…¥å£å”¯ä¸€

`stores/index`

```ts
export * from './modules/user'
```

`App.vue`
```diff
-import { useUserStore } from './stores/user'
+import { useUserStore } from './stores'
```

å°ç»“ï¼š
- ç»Ÿä¸€å¯¼å‡ºæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ
  - ä¸€ä¸ªæ¨¡å—ä¸‹çš„æ‰€æœ‰èµ„æºé€šè¿‡indexå¯¼å‡º


## è¯·æ±‚å·¥å…·å‡½æ•°{#request}

### æ‹¦æˆªå™¨é€»è¾‘{#request-interceptors}


> å®ç°ï¼štokenè¯·æ±‚å¤´æºå¸¦ï¼Œé”™è¯¯å“åº”å¤„ç†ï¼Œ401é”™è¯¯å¤„ç†

`utils/request.ts`

æ¨¡æ¿ä»£ç ï¼š

```ts
import axios from 'axios'

const instance = axios.create({
  // TODO 1. åŸºç¡€åœ°å€ï¼Œè¶…æ—¶æ—¶é—´
})

instance.interceptors.request.use(
  (config) => {
    // TODO 2. æºå¸¦token
    return config
  },
  (err) => Promise.reject(err)
)

instance.interceptors.response.use(
  (res) => {
    // TODO 3. å¤„ç†ä¸šåŠ¡å¤±è´¥
    // TODO 4. æ‘˜å–æ ¸å¿ƒå“åº”æ•°æ®
    return res
  },
  (err) => {
    // TODO 5. å¤„ç†401é”™è¯¯
    return Promise.reject(err)
  }
)

export default instance
```
ä»£ç å®ç°ï¼š

```ts
import { useUserStore } from '@/stores'
import router from '@/router'
import axios from 'axios'
import { showToast } from 'vant'

// 1. æ–°axioså®ä¾‹ï¼ŒåŸºç¡€é…ç½®
const instance = axios.create({
  baseURL: 'https://consult-api.itheima.net/',
  timeout: 10000
})

// 2. è¯·æ±‚æ‹¦æˆªå™¨ï¼Œæºå¸¦token
instance.interceptors.request.use(
  (config) => {
    const store = useUserStore()
    if (store.user?.token && config.headers) {
      config.headers['Authorization'] = `Bearer ${store.user?.token}`
    }
    return config
  },
  (err) => Promise.reject(err)
)

// 3. å“åº”æ‹¦æˆªå™¨ï¼Œå‰¥ç¦»æ— æ•ˆæ•°æ®ï¼Œ401æ‹¦æˆª
instance.interceptors.response.use(
  (res) => {
    // åå°çº¦å®šï¼Œå“åº”æˆåŠŸï¼Œä½†æ˜¯codeä¸æ˜¯10000ï¼Œæ˜¯ä¸šåŠ¡é€»è¾‘å¤±è´¥
    if (res.data?.code !== 10000) {
      showToast(res.data?.message || 'ä¸šåŠ¡å¤±è´¥')
      return Promise.reject(res.data)
    }
    // ä¸šåŠ¡é€»è¾‘æˆåŠŸï¼Œè¿”å›å“åº”æ•°æ®ï¼Œä½œä¸ºaxiosæˆåŠŸçš„ç»“æœ
    return res.data
  },
  (err) => {
    if (err.response.status === 401) {
      // åˆ é™¤ç”¨æˆ·ä¿¡æ¯
      const store = useUserStore()
      store.delUser()
      // è·³è½¬ç™»å½•ï¼Œå¸¦ä¸Šæ¥å£å¤±æ•ˆæ‰€åœ¨é¡µé¢çš„åœ°å€ï¼Œç™»å½•å®Œæˆåå›è·³ä½¿ç”¨
      router.push({
        path: '/login',
        query: { returnUrl: router.currentRoute.value.fullPath }
      })
    }
    return Promise.reject(err)
  }
)

export { baseURL, instance }
```

æé—®ï¼š
- baseURL å¯¼å‡ºçš„ç›®çš„æ˜¯å•¥ï¼Ÿ
  - å…¶ä»–æ¨¡å—å¯èƒ½éœ€è¦ä½¿ç”¨

- ä¸ºä»€ä¹ˆä½¿ç”¨å‡½æ•° `useXxxStore` å‡½æ•°ï¼Œå»ºè®®åœ¨æ‹¦æˆªå™¨ä½¿ç”¨ï¼Ÿ
  - æ¨¡å—ä¸­çš„è¯ï¼Œstoreå¯èƒ½è¿˜æ²¡åˆå§‹åŒ–

- ä¸šåŠ¡æˆåŠŸæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ
  - å“åº”æˆåŠŸï¼Œä¸”åå°ä¸šåŠ¡æ“ä½œå®Œæ¯•

### å·¥å…·å‡½æ•°å°è£…{#request-fn}

> å®ç°ï¼šå¯¼å‡ºä¸€ä¸ªé€šç”¨çš„è¯·æ±‚å·¥å…·å‡½æ•°ï¼Œæ”¯æŒè®¾ç½®å“åº”æ•°æ®ç±»å‹

- å¯¼å‡ºä¸€ä¸ªé€šç”¨çš„è¯·æ±‚å·¥å…·å‡½æ•°
```ts
import axios, { AxiosError, type Method } from 'axios'

// 4. è¯·æ±‚å·¥å…·å‡½æ•°
const request = (url: string, method: Method = 'GET', submitData?: object) => {
  return instance.request({
    url,
    method,
    [method.toUpperCase() === 'GET' ? 'params' : 'data']: submitData
  })
}
```

- æ”¯æŒä¸åŒæ¥å£è®¾ä¸åŒçš„å“åº”æ•°æ®çš„ç±»å‹

åŠ ä¸Šæ³›å‹
```ts
// è¿™ä¸ªéœ€è¦æ›¿æ¢axsio.requesté»˜è®¤çš„å“åº”æˆåŠŸåçš„ç»“æœç±»å‹
// ä¹‹å‰æ˜¯ï¼šä¼  { name: string } ç„¶åresæ˜¯   res = { data: { name: string } }
// ä½†ç°åœ¨ï¼šåœ¨å“åº”æ‹¦æˆªå™¨ä¸­è¿”å›äº† res.data  ä¹Ÿå°±æ˜¯å°†æ¥å“åº”æˆåŠŸåçš„ç»“æœï¼Œå’Œä¸Šé¢çš„ç±»å‹ä¸€è‡´å—ï¼Ÿ
// æ‰€ä»¥è¦ï¼šrequest<æ•°æ®ç±»å‹ï¼Œæ•°æ®ç±»å‹>() è¿™æ ·æ‰æŒ‡å®šäº† res.data çš„ç±»å‹
// ä½†æ˜¯å‘¢ï¼šåå°è¿”å›çš„æ•°æ®ç»“æ„ç›¸åŒï¼Œæ‰€ä»¥å¯ä»¥æŠ½å–ç›¸åŒçš„ç±»å‹
type Data<T> = {
  code: number
  message: string
  data: T
}
// 4. è¯·æ±‚å·¥å…·å‡½æ•°
const request = <T>(url: string, method: Method = 'get', submitData?: object) => {
  return instance.request<T, Data<T>>({
    url,
    method,
    [method.toLowerCase() === 'get' ? 'params' : 'data']: submitData
  })
}
```


### æµ‹è¯•è¯·æ±‚å·¥å…·{#request-test}

> æµ‹è¯•ï¼šå°è£…å¥½çš„è¯·æ±‚å·¥å…·å‡½æ•°


`App.vue`
```vue
<script setup lang="ts">
import { request } from '@/utils/request'
import type { User } from './types/user'
import { Button as VanButton } from 'vant'
import { useUserStore } from './stores'

// æµ‹è¯•ï¼Œè¯·æ±‚æ‹¦æˆªå™¨ï¼Œæ˜¯å¦æºå¸¦tokenï¼Œå“åº”æ‹¦æˆªå™¨401æ‹¦æˆªåˆ°ç™»å½•åœ°å€
const getUserInfo = async () => {
  const res = await request('/patient/myUser')
  console.log(res)
}

// æµ‹è¯•ï¼Œå“åº”æ‹¦æˆªå™¨ï¼Œå‡ºç°é10000çš„æƒ…å†µï¼Œå’Œè¿”å›å‰¥ç¦»åçš„æ•°æ®
const store = useUserStore()
const login = async () => {
  const res = await request<User>('/login/password', 'POST', {
    mobile: '13211112222',
    // å¯†ç  abc123456 æµ‹è¯•ï¼šå‡ºç°é10000çš„æƒ…å†µ
    password: 'abc12345'
  })
  store.setUser(res.data)
}
</script>

<template>
  <van-button type="primary" @click="getUserInfo">è·å–ä¸ªäººä¿¡æ¯</van-button>
  <van-button type="primary" @click="login">ç™»å½•</van-button>
</template>
```

æµ‹è¯•ï¼š
- ç™»å½•çš„æ—¶å€™æŠŠå¯†ç æ”¹é”™ï¼Œæ˜¯æµ‹è¯•ï¼Ÿ
  - ä¸šåŠ¡é€»è¾‘å¤±è´¥
- ç™»å½•æˆåŠŸï¼Œçœ‹ res æ‰“å°ï¼Œæ˜¯æµ‹è¯•ï¼Ÿ
  - å‰¥ç¦»ä¸€å±‚æ•°æ®
- è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸï¼Œæ˜¯æµ‹è¯•ï¼Ÿ
  - æ˜¯å¦æºå¸¦token
- æŠŠ token åˆ é™¤æˆ–ä¿®æ”¹ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œæ˜¯æµ‹è¯•ï¼Ÿ
  - 401 token å¤±æ•ˆè·³è½¬ login é¡µé¢


